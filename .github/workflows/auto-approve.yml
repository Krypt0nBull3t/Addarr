# File: .github/workflows/auto-approve.yml
# Description: AI-powered PR review and auto-approve when CI passes

name: PR Review

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  pull-requests: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Get PR number and diff
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // Find the PR for this branch
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });
            if (pulls.data.length === 0) {
              core.setFailed('No open PR found for this branch');
              return;
            }
            const prNumber = pulls.data[0].number;
            core.setOutput('number', prNumber);

            // Get the diff
            const diff = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              mediaType: { format: 'diff' }
            });
            const fs = require('fs');
            // Truncate diff to ~100KB to stay within model context limits
            const diffText = diff.data.substring(0, 100000);
            fs.writeFileSync('pr_diff.txt', diffText);

            // Get PR details
            const pr = pulls.data[0];
            core.setOutput('title', pr.title);
            core.setOutput('body', pr.body || 'No description provided');

      - name: Rule-based checks
        id: rules
        if: steps.pr.outputs.number
        run: |
          WARNINGS=""

          # Check for TODO/FIXME/HACK comments in added lines
          TODOS=$(grep "^+" pr_diff.txt | grep -iE "(TODO|FIXME|HACK|XXX)" | head -10 || true)
          if [ -n "$TODOS" ]; then
            WARNINGS="${WARNINGS}\n**TODOs/FIXMEs found in new code:**\n\`\`\`\n${TODOS}\n\`\`\`\n"
          fi

          # Check for print statements in added Python lines
          PRINTS=$(grep "^+" pr_diff.txt | grep -E "^\+.*\bprint\(" | grep -v "^+++" | grep -v "#" | head -10 || true)
          if [ -n "$PRINTS" ]; then
            WARNINGS="${WARNINGS}\n**Print statements found (use logger instead):**\n\`\`\`\n${PRINTS}\n\`\`\`\n"
          fi

          # Check for large files (>500 lines added)
          LARGE_FILES=$(grep "^+++ b/" pr_diff.txt | while read -r file; do
            fname=$(echo "$file" | sed 's/^+++ b\///')
            added=$(grep -c "^+" pr_diff.txt || true)
            if [ "$added" -gt 500 ]; then
              echo "- $fname ($added lines added)"
            fi
          done || true)
          if [ -n "$LARGE_FILES" ]; then
            WARNINGS="${WARNINGS}\n**Large changes detected:**\n${LARGE_FILES}\n"
          fi

          # Check for hardcoded secrets patterns
          SECRETS=$(grep "^+" pr_diff.txt | grep -iE "(api_key|apikey|secret|password|token)\s*=\s*['\"][^'\"]+['\"]" | grep -v "^+++" | head -5 || true)
          if [ -n "$SECRETS" ]; then
            WARNINGS="${WARNINGS}\n**‚ö†Ô∏è Possible hardcoded secrets found ‚Äî please verify:**\n\`\`\`\n${SECRETS}\n\`\`\`\n"
          fi

          # Check for bare except clauses
          BARE_EXCEPT=$(grep "^+" pr_diff.txt | grep -E "^\+\s*except\s*:" | grep -v "^+++" | head -5 || true)
          if [ -n "$BARE_EXCEPT" ]; then
            WARNINGS="${WARNINGS}\n**Bare except clauses found (use specific exceptions):**\n\`\`\`\n${BARE_EXCEPT}\n\`\`\`\n"
          fi

          if [ -n "$WARNINGS" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            # Write to file to preserve formatting
            printf "%b" "$WARNINGS" > rule_warnings.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No issues found" > rule_warnings.txt
          fi

      - name: AI code review via Groq
        id: ai_review
        if: steps.pr.outputs.number
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          # Build the prompt
          cat > prompt.json << 'PROMPT_END'
          {
            "model": "qwen/qwen3-32b",
            "temperature": 0.3,
            "max_tokens": 4096,
            "messages": [
              {
                "role": "system",
                "content": "You are a code reviewer for a Python Telegram bot project (Addarr). Review the PR diff and provide concise, actionable feedback. Focus on:\n1. Bugs or logic errors\n2. Security concerns\n3. Error handling issues\n4. Breaking changes\n5. Code quality improvements\n\nFormat your response as:\n## Summary\nOne paragraph overview of the changes.\n\n## Issues\nList any problems found, or 'No issues found.' if the code looks good.\n\n## Suggestions\nList optional improvements, or 'No suggestions.' if nothing to add.\n\nBe concise. Do not repeat the diff. Do not comment on formatting or whitespace."
              },
              {
                "role": "user",
                "content": "PLACEHOLDER"
              }
            ]
          }
          PROMPT_END

          # Insert the diff into the prompt (escape for JSON)
          DIFF_CONTENT=$(cat pr_diff.txt | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))")
          PR_TITLE="${{ steps.pr.outputs.title }}"
          USER_MSG="Review this PR.\n\nTitle: ${PR_TITLE}\n\nDiff:\n${DIFF_CONTENT}"
          USER_MSG_JSON=$(python3 -c "import json; print(json.dumps('''$PR_TITLE'''[:100]))" 2>/dev/null || echo '"PR"')

          # Build proper request with Python to handle escaping
          python3 << 'EOF'
          import json, os

          with open('pr_diff.txt', 'r') as f:
              diff = f.read()

          title = os.environ.get('PR_TITLE', 'PR Review')

          with open('prompt.json', 'r') as f:
              request = json.load(f)

          request['messages'][1]['content'] = f"Review this PR.\n\nTitle: {title}\n\nDiff:\n{diff}"

          with open('request.json', 'w') as f:
              json.dump(request, f)
          EOF

          # Call Groq API
          RESPONSE=$(curl -s -X POST "https://api.groq.com/openai/v1/chat/completions" \
            -H "Authorization: Bearer ${GROQ_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @request.json)

          # Extract the review text and strip <think> blocks from Qwen
          REVIEW=$(echo "$RESPONSE" | python3 -c "
          import sys, json, re
          try:
              data = json.load(sys.stdin)
              content = data['choices'][0]['message']['content']
              content = re.sub(r'<think>.*?</think>\s*', '', content, flags=re.DOTALL)
              print(content.strip())
          except (KeyError, IndexError, json.JSONDecodeError) as e:
              print(f'AI review unavailable: {e}')
          ")

          echo "$REVIEW" > ai_review.txt

      - name: Post review comment
        if: steps.pr.outputs.number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REVIEWER_BOT_TOKEN }}
          script: |
            const fs = require('fs');
            const aiReview = fs.readFileSync('ai_review.txt', 'utf8');
            const ruleWarnings = fs.readFileSync('rule_warnings.txt', 'utf8');
            const hasWarnings = '${{ steps.rules.outputs.found }}' === 'true';

            let body = `## ü§ñ Automated PR Review\n\n`;
            body += `### AI Review\n${aiReview}\n\n`;

            if (hasWarnings) {
              body += `### ‚ö†Ô∏è Rule-based Warnings\n${ruleWarnings}\n\n`;
            } else {
              body += `### ‚úÖ Rule-based Checks\nNo issues found.\n\n`;
            }

            // Post the review comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: body
            });

      - name: Approve PR
        if: steps.pr.outputs.number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REVIEWER_BOT_TOKEN }}
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }},
              event: 'APPROVE',
              body: 'All CI checks passed. Review complete ‚Äî auto-approved.'
            });
